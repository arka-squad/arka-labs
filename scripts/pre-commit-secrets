#!/usr/bin/env bash
set -euo pipefail

# 1) Interdiction du stub en CI : exige un binaire réel
if [ "${CI:-}" = "true" ]; then
  if ! gitleaks version 2>/dev/null | grep -qE '^v[0-9]'; then
    echo "ERROR: gitleaks réel requis en CI (pas de stub)." >&2
    exit 1
  fi
fi

# 2) Tolérance locale (offline) : skip propre si gitleaks absent
if ! command -v gitleaks >/dev/null 2>&1; then
  echo "WARN: gitleaks absent en local (offline) → hook ignoré, contrôle assuré par la CI." >&2
  exit 0
fi

# 3) Exécution standard avec rapport JSON
mkdir -p .reports
gitleaks detect \
  --source . \
  --report-format json \
  --report-path .reports/gitleaks.report.json \
  --exit-code 1

echo "OK: gitleaks exécuté (rapport: .reports/gitleaks.report.json)"

