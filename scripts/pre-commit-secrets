#!/usr/bin/env bash
set -euo pipefail

# CI policy: the authoritative scan runs in GitHub Actions via gitleaks-action.
# In CI, this hook must NOT block (unless explicitly enforced).
if [ "${CI:-}" = "true" ] && [ "${ENFORCE_CI_GITLEAKS:-0}" != "1" ]; then
  echo "INFO: CI uses gitleaks GitHub Action → hook skipped."
  exit 0
fi

if ! command -v gitleaks >/dev/null 2>&1; then
  echo "WARN: gitleaks absent en local (offline) → hook ignoré, contrôle assuré par la CI." >&2
  exit 0
fi

# Local (or enforced CI): run detect with JSON report
mkdir -p .reports
gitleaks detect \
  --source . \
  --report-format json \
  --report-path .reports/gitleaks.report.json \
  --exit-code 1

echo "OK: gitleaks exécuté (rapport: .reports/gitleaks.report.json)"

